<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout | J4R Box</title>
  <link rel="icon" type="image/png" href="./images/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { font-family: 'Orbitron', sans-serif !important; }
    body { background: #000; color: #fff; min-height: 100vh; }
    
    canvas {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      z-index: 0;
    }

    .page-content { position: relative; z-index: 1; }
    
    #map { 
      height: 400px; 
      border-radius: 12px; 
      border: 2px solid rgba(56, 182, 255, 0.3);
      position: relative;
      z-index: 1;
    }
    
    .payment-option {
      padding: 1.5rem;
      border: 2px solid rgba(56, 182, 255, 0.3);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      background: rgba(15, 23, 32, 0.5);
    }
    
    .payment-option.active {
      border-color: #38b6ff;
      background: rgba(56, 182, 255, 0.1);
      box-shadow: 0 0 20px rgba(56, 182, 255, 0.4);
    }
    
    .payment-option.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      filter: grayscale(1);
    }
    
    .payment-option.available {
      animation: glow 2s ease-in-out infinite;
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 10px rgba(56, 182, 255, 0.3); }
      50% { box-shadow: 0 0 25px rgba(56, 182, 255, 0.6); }
    }
    
    .voucher-input {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(56, 182, 255, 0.3);
      color: white;
      padding: 0.75rem;
      border-radius: 8px;
      width: 100%;
      font-family: 'Orbitron', sans-serif;
    }
    
    .voucher-input:focus {
      outline: none;
      border-color: #38b6ff;
      box-shadow: 0 0 15px rgba(56, 182, 255, 0.3);
    }
    
    .order-summary {
      background: linear-gradient(135deg, rgba(15, 23, 32, 0.8), rgba(10, 20, 32, 0.9));
      border: 2px solid rgba(56, 182, 255, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .success-animation {
      animation: successPop 0.6s ease-out;
    }
    
    @keyframes successPop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .btn-primary {
      background: linear-gradient(135deg, #38b6ff, #93ffd8);
      color: #000;
      font-weight: 700;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: scale(1.02);
      box-shadow: 0 0 30px rgba(56, 182, 255, 0.6);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ‚úÖ Success modal above everything */
    #successModal {
      z-index: 99999 !important;
      position: fixed !important;
    }

    /* ‚úÖ Map stays below */
    .leaflet-container {
      z-index: 1 !important;
    }
  </style>
</head>
<body class="min-h-screen p-4">

  <canvas></canvas>

  <div class="page-content">
    <div class="max-w-6xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-4xl font-bold" style="color:#38b6ff;text-shadow:0 0 20px rgba(56,182,255,0.6)">Checkout</h1>
        <a href="shop.html" class="text-slate-400 hover:text-cyan-400 transition">‚Üê Back to Shop</a>
      </div>
      
      <div class="grid lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 space-y-6">
          
          <div class="order-summary">
            <h2 class="text-2xl font-bold mb-4 text-cyan-400">üìç Delivery Address</h2>
            <div id="map"></div>
            <input type="text" id="addressInput" placeholder="Search location or click on map..." class="voucher-input mt-4">
            <p class="text-sm text-slate-400 mt-2">üìå Default: Margosatubig, Zamboanga del Sur</p>
            <p id="deliveryTime" class="text-green-400 font-bold mt-3"></p>
          </div>
          
          <div class="order-summary">
            <h2 class="text-2xl font-bold mb-4 text-cyan-400">üí≥ Payment Method</h2>
            <div class="space-y-3">
              <div class="payment-option available active" data-payment="cod">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">üíµ</span>
                  <div>
                    <div class="font-bold text-lg">Cash on Delivery</div>
                    <div class="text-sm text-slate-400">Pay when you receive</div>
                  </div>
                </div>
              </div>
              
              <div class="payment-option disabled" data-payment="gcash">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">üì±</span>
                  <div>
                    <div class="font-bold text-lg">GCash</div>
                    <div class="text-sm text-red-400">Coming Soon</div>
                  </div>
                </div>
              </div>
              
              <div class="payment-option disabled" data-payment="card">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">üí≥</span>
                  <div>
                    <div class="font-bold text-lg">Credit/Debit Card</div>
                    <div class="text-sm text-red-400">Coming Soon</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="order-summary">
            <h2 class="text-2xl font-bold mb-4 text-cyan-400">üéüÔ∏è Voucher Code</h2>
            <div class="flex gap-3">
              <input type="text" id="voucherInput" placeholder="Enter voucher code (e.g., JayRide)..." class="voucher-input">
              <button id="applyVoucherBtn" class="px-6 py-3 rounded-lg font-bold btn-primary">
                Apply
              </button>
            </div>
            <p id="voucherMessage" class="text-sm mt-2"></p>
            <div class="mt-3 text-xs text-slate-400">
              üí° Tip: Try "JayRide" for 50% off the highest priced item!
            </div>
          </div>
          
        </div>
        
        <div class="space-y-6">
          <div class="order-summary">
            <h2 class="text-2xl font-bold mb-4 text-cyan-400">üì¶ Order Summary</h2>
            
            <div id="orderItems" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
            </div>
            
            <div class="border-t border-cyan-500/30 pt-3 space-y-2">
              <div class="flex justify-between text-sm">
                <span>Subtotal</span>
                <span id="subtotalAmount">‚Ç±0</span>
              </div>
              <div class="flex justify-between text-sm text-green-400" id="discountRow" style="display: none;">
                <span>Discount</span>
                <span id="discountAmount">-‚Ç±0</span>
              </div>
              <div class="flex justify-between text-xl font-bold border-t border-cyan-500/30 pt-2">
                <span>Total</span>
                <span id="totalAmount">‚Ç±0</span>
              </div>
            </div>
            
            <button id="placeOrderBtn" class="w-full py-4 mt-4 rounded-lg font-bold text-lg btn-primary">
              Place Order üõí
            </button>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
  <div id="successModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center p-4" style="z-index: 99999 !important;">
    <div class="order-summary max-w-md w-full success-animation">
      <div class="text-center">
        <div class="text-6xl mb-4">üì¶‚ú®</div>
        <h2 class="text-3xl font-bold mb-4 text-green-400">Order Placed!</h2>
        <p class="text-lg mb-2">Thank you for your purchase!</p>
        <p class="text-slate-400 mb-4">Your order will arrive in <span id="estimatedDays" class="text-cyan-400 font-bold"></span></p>
        
        <div class="bg-black/30 p-4 rounded-lg mb-4 text-left">
          <p class="text-sm text-slate-400 mb-2">üìã Order Details:</p>
          <p id="orderSummaryText" class="text-sm"></p>
        </div>
        
        <button onclick="window.location.href='shop.html'" class="w-full py-3 rounded-lg font-bold btn-primary">
          Continue Shopping
        </button>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ Animated background (same as index)
    var canvasDots = function() {
      var canvas = document.querySelector('canvas'),
          ctx = canvas.getContext('2d'),
          colorDot = '#38b6ff',
          color = '#38b6ff';
      
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.display = 'block';
      ctx.fillStyle = colorDot;
      ctx.lineWidth = .1;
      ctx.strokeStyle = color;

      var mousePosition = { x: canvas.width / 2, y: canvas.height / 2 };
      var dots = { nb: 350, distance: 60, d_radius: 100, array: [] };

      function Dot(){
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = -.5 + Math.random();
        this.vy = -.5 + Math.random();
        this.radius = Math.random();
      }

      Dot.prototype = {
        create: function(){ ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false); ctx.fill(); },
        animate: function(){
          for(var i = 0; i < dots.nb; i++){
            var dot = dots.array[i];
            if(dot.y < 0 || dot.y > canvas.height){ dot.vx = dot.vx; dot.vy = - dot.vy; }
            else if(dot.x < 0 || dot.x > canvas.width){ dot.vx = - dot.vx; dot.vy = dot.vy; }
            dot.x += dot.vx; dot.y += dot.vy;
          }
        },
        line: function(){
          for(var i = 0; i < dots.nb; i++){
            for(var j = 0; j < dots.nb; j++){
              var i_dot = dots.array[i], j_dot = dots.array[j];
              if((i_dot.x - j_dot.x) < dots.distance && (i_dot.y - j_dot.y) < dots.distance && 
                 (i_dot.x - j_dot.x) > - dots.distance && (i_dot.y - j_dot.y) > - dots.distance){
                if((i_dot.x - mousePosition.x) < dots.d_radius && (i_dot.y - mousePosition.y) < dots.d_radius && 
                   (i_dot.x - mousePosition.x) > - dots.d_radius && (i_dot.y - mousePosition.y) > - dots.d_radius){
                  ctx.beginPath(); ctx.moveTo(i_dot.x, i_dot.y); ctx.lineTo(j_dot.x, j_dot.y); ctx.stroke(); ctx.closePath();
                }
              }
            }
          }
        }
      };

      function createDots(){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for(var i = 0; i < dots.nb; i++){ dots.array.push(new Dot()); dots.array[i].create(); }
        dots.array[0].line(); dots.array[0].animate();
      }

      window.onmousemove = function(e) { mousePosition.x = e.pageX; mousePosition.y = e.pageY; }
      window.addEventListener('resize', function(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
      setInterval(createDots, 1000/30);
    };

    window.onload = function() { canvasDots(); };

    // ============= CHECKOUT LOGIC =============
    
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    
    if(!user) {
      alert('‚ùå Please login first!');
      window.location.href = 'shop.html?openAuth=true';
    }
    
    const cartKey = user && user.email ? 'cart_' + user.email : 'cart';
    let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
    let products = JSON.parse(localStorage.getItem('cachedProducts') || '[]');
    
    if(cart.length === 0) {
      alert('‚ö†Ô∏è Your cart is empty!');
      window.location.href = 'shop.html';
    }
    
    let selectedLocation = null;
    let appliedVoucher = null;
    let selectedPayment = 'cod';
    
    // Initialize map
    const map = L.map('map').setView([7.7431, 123.7309], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    let marker = L.marker([7.7431, 123.7309], { draggable: true }).addTo(map);
    selectedLocation = { lat: 7.7431, lng: 123.7309 };
    marker.bindPopup("<b>Delivery Location</b><br>Drag me or click map!").openPopup();
    
    map.on('click', (e) => {
      selectedLocation = e.latlng;
      marker.setLatLng(e.latlng);
      updateDeliveryTime();
    });
    
    marker.on('dragend', (e) => {
      selectedLocation = marker.getLatLng();
      updateDeliveryTime();
    });
    
    function updateDeliveryTime() {
      if(!selectedLocation) return;
      const baseLat = 7.7431, baseLng = 123.7309;
      const distance = Math.sqrt(Math.pow(selectedLocation.lat - baseLat, 2) + Math.pow(selectedLocation.lng - baseLng, 2));
      const days = Math.max(1, Math.min(7, Math.ceil(distance * 100)));
      document.getElementById('deliveryTime').textContent = `üìÖ Estimated delivery: ${days} day${days > 1 ? 's' : ''}`;
      return days;
    }
    
    updateDeliveryTime();
    
    document.querySelectorAll('.payment-option:not(.disabled)').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
        option.classList.add('active');
        selectedPayment = option.dataset.payment;
      });
    });
    
    function calculateTotals() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
      let discount = 0, discountedItem = null;
      
      if(appliedVoucher === 'JayRide') {
        let highestPricedItem = null, highestPrice = 0;
        cart.forEach(item => {
          if(item.price > highestPrice) {
            highestPrice = item.price;
            highestPricedItem = item;
          }
        });
        if(highestPricedItem) {
          discount = highestPrice * 0.5;
          discountedItem = highestPricedItem.name;
        }
      }
      
      const total = subtotal - discount;
      document.getElementById('subtotalAmount').textContent = '‚Ç±' + subtotal.toLocaleString();
      document.getElementById('totalAmount').textContent = '‚Ç±' + total.toLocaleString();
      
      if(discount > 0) {
        document.getElementById('discountRow').style.display = 'flex';
        document.getElementById('discountAmount').textContent = '-‚Ç±' + discount.toLocaleString();
        document.getElementById('voucherMessage').textContent = `‚úÖ 50% off on 1x ${discountedItem}`;
        document.getElementById('voucherMessage').className = 'text-sm mt-2 text-green-400';
      } else {
        document.getElementById('discountRow').style.display = 'none';
      }
      
      return { subtotal, discount, total };
    }
    
    document.getElementById('applyVoucherBtn').addEventListener('click', () => {
      const code = document.getElementById('voucherInput').value.trim();
      const msg = document.getElementById('voucherMessage');
      if(code === 'JayRide') {
        appliedVoucher = 'JayRide';
        calculateTotals();
      } else if(code) {
        msg.textContent = '‚ùå Invalid voucher code. Try "JayRide"!';
        msg.className = 'text-sm mt-2 text-red-400';
        appliedVoucher = null;
        calculateTotals();
      }
    });
    
    function loadOrderItems() {
      const container = document.getElementById('orderItems');
      container.innerHTML = cart.map(item => `
        <div class="flex justify-between text-sm border-b border-cyan-500/20 pb-2">
          <span class="flex-1">${item.name} <span class="text-cyan-400">√ó${item.qty}</span></span>
          <span class="font-semibold">‚Ç±${(item.price * item.qty).toLocaleString()}</span>
        </div>
      `).join('');
      calculateTotals();
    }
    
    loadOrderItems();
    
    // ‚úÖ FIXED: Use dedicated stock endpoint (no auth required)
async function syncStockToMongoDB(cartItems) {
  const API_BASE = 'https://j4r-box-api.onrender.com';
  
  for (const cartItem of cartItems) {
    const product = products.find(p => p._id === cartItem._id);
    if(!product || product.category !== 'physical' || product.stock >= 999) continue;
    
    try {
      console.log(`üîÑ Syncing ${product.name} (stock: ${product.stock}) to MongoDB...`);
      
      // ‚úÖ Use new stock-only endpoint
      const response = await fetch(`${API_BASE}/api/products/${product._id}/stock`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          stock: product.stock
        })
      });
      
      if(response.ok) {
        const result = await response.json();
        if(result.success) {
          console.log(`‚úÖ MongoDB: ${result.product.name} stock ‚Üí ${result.product.stock}`);
        } else {
          console.log(`‚ÑπÔ∏è ${result.message}`);
        }
      } else {
        const errorText = await response.text();
        console.error(`‚ùå MongoDB sync failed for ${product.name}:`, errorText);
      }
    } catch(error) {
      console.error(`‚ùå Network error syncing ${product.name}:`, error.message);
    }
  }
}
    
    // ‚úÖ Place Order Button Handler
    document.getElementById('placeOrderBtn').addEventListener('click', async () => {
      if(!selectedLocation) {
        alert('‚ùå Please select a delivery location on the map!');
        return;
      }
      
      const days = updateDeliveryTime();
      const { subtotal, discount, total } = calculateTotals();
      
      console.log('\nüõí Processing order...');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      
      // ‚úÖ Step 1: Update stock locally (instant feedback)
      const cartCopy = [...cart];
      cartCopy.forEach(cartItem => {
        const product = products.find(p => p._id === cartItem._id);
        if(product && product.category === 'physical' && product.stock < 999) {
          const oldStock = product.stock;
          product.stock = Math.max(0, product.stock - cartItem.qty);
          console.log(`üì¶ ${product.name}: Stock ${oldStock} ‚Üí ${product.stock} (-${cartItem.qty})`);
        }
      });
      
      localStorage.setItem('cachedProducts', JSON.stringify(products));
      console.log('‚úÖ Local stock updated');
      
      // ‚úÖ Step 2: Sync to MongoDB (background)
      console.log('üîÑ Syncing to MongoDB...');
      syncStockToMongoDB(cartCopy).then(() => {
        console.log('‚úÖ MongoDB sync complete');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
      }).catch(err => {
        console.warn('‚ö†Ô∏è MongoDB sync failed (local stock still updated):', err);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
      });
      
      // ‚úÖ Step 3: Clear cart
      localStorage.removeItem(cartKey);
      console.log('üóëÔ∏è Cart cleared');
      
      // ‚úÖ Step 4: Show success modal
      document.getElementById('estimatedDays').textContent = `${days} day${days > 1 ? 's' : ''}`;
      let orderText = `${cartCopy.length} item(s) ‚Ä¢ Total: ‚Ç±${total.toLocaleString()}`;
      if(discount > 0) orderText += ` (Saved ‚Ç±${discount.toLocaleString()} with JayRide!)`;
      orderText += `\nPayment: ${selectedPayment.toUpperCase()}`;
      document.getElementById('orderSummaryText').textContent = orderText;
      
      const modal = document.getElementById('successModal');
      modal.classList.remove('hidden');
      modal.style.zIndex = '99999';
      modal.style.position = 'fixed';
      
      console.log('‚úÖ Order complete!');
    });

    document.getElementById('addressInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') {
        const query = e.target.value.trim();
        if(query) alert(`üîç Searching for: ${query}\n\nFor demo purposes, please click on the map to set your exact location.`);
      }
    });
  </script>
</body>
</html>